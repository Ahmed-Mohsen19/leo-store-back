<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account</title>
    <link rel="stylesheet" href="./Css/Signup.css">
</head>
<body>
    <section>
        <div class="color"></div>
        <div class="color"></div>
        <div class="color"></div>
        <div class="container">
            <div class="form">
                <h2>Create Account</h2>
                <div id="error-message" style="color: red; margin-bottom: 10px; display: none;"></div>
                <div id="success-message" style="color: green; margin-bottom: 10px; display: none;"></div>
                <div style="color: #ccc; font-size: 12px; margin-bottom: 15px; text-align: center;">
                    Names must be at least 3 characters long<br>
                    Password must contain: 8+ chars, uppercase, lowercase, number, special character
                </div>
                <form id="signup-form">
                    <div class="inputBox">
                        <input type="text" id="fname" name="fname" placeholder="First Name (min 3 chars)" required minlength="3">
                    </div>
                    <div class="inputBox">
                        <input type="text" id="lname" name="lname" placeholder="Last Name (min 3 chars)" required minlength="3">
                    </div>
                    <div class="inputBox">
                        <input type="email" id="email" name="email" placeholder="Email" required>
                    </div>
                    <div class="inputBox">
                        <input type="password" id="password" name="password" placeholder="Password (uppercase, lowercase, number, special char)" required minlength="8">
                    </div>
                    <div class="inputBox">
                        <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm Password" required>
                    </div>
                    <div class="inputBox">
                        <input type="submit" value="Submit" id="signup-btn">
                    </div>
                </form>
                <p class="forget">Already have an account? <a href="./Login.html">Login</a></p>
                <p style="margin-top: 15px; text-align: center;"><a href="index.html" style="color: #4946fd;">‚Üê Back to Home</a></p>
            </div>
        </div>
    </section>

    <!-- Firebase SDK -->
    <script type="module" src="./js/firebase.js"></script>
    <script type="module" src="./js/sessionService.js"></script>
    <script type="module" src="./js/auth.js"></script>
    
    <script type="module">
        // Password strength validation function
        function validatePasswordStrength(password) {
            const minLength = 8;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

            const requirements = [];
            if (password.length < minLength) requirements.push("at least 8 characters");
            if (!hasUpperCase) requirements.push("one uppercase letter");
            if (!hasLowerCase) requirements.push("one lowercase letter");
            if (!hasNumbers) requirements.push("one number");
            if (!hasSpecialChar) requirements.push("one special character (@, #, $, etc.)");

            if (requirements.length > 0) {
                return {
                    isValid: false,
                    message: "Password must contain: " + requirements.join(", ")
                };
            }

            return { isValid: true };
        }

        // Wait for auth service to be available
        function waitForAuthService() {
            return new Promise((resolve) => {
                const checkAuth = setInterval(() => {
                    if (window.authService) {
                        clearInterval(checkAuth);
                        resolve();
                    }
                }, 100);
            });
        }

        async function initSignup() {
            await waitForAuthService();
            
            const signupForm = document.getElementById("signup-form");
            const signupBtn = document.getElementById("signup-btn");
            const errorMessage = document.getElementById("error-message");
            const successMessage = document.getElementById("success-message");

            signupForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const firstName = document.getElementById("fname").value.trim();
                const lastName = document.getElementById("lname").value.trim();
                const email = document.getElementById("email").value.trim();
                const password = document.getElementById("password").value;
                const confirmPassword = document.getElementById("confirm-password").value;

                // Clear previous messages
                errorMessage.style.display = "none";
                successMessage.style.display = "none";

                // Validation
                if (!firstName || !lastName || !email || !password || !confirmPassword) {
                    errorMessage.textContent = "Please fill in all fields.";
                    errorMessage.style.display = "block";
                    return;
                }

                if (firstName.length < 3) {
                    errorMessage.textContent = "First name must be at least 3 characters long.";
                    errorMessage.style.display = "block";
                    return;
                }

                if (lastName.length < 3) {
                    errorMessage.textContent = "Last name must be at least 3 characters long.";
                    errorMessage.style.display = "block";
                    return;
                }

                // Password strength validation
                const passwordValidation = validatePasswordStrength(password);
                if (!passwordValidation.isValid) {
                    errorMessage.textContent = passwordValidation.message;
                    errorMessage.style.display = "block";
                    return;
                }

                if (password !== confirmPassword) {
                    errorMessage.textContent = "Passwords do not match. Please try again.";
                    errorMessage.style.display = "block";
                    return;
                }

                // Validate confirm password strength as well
                const confirmPasswordValidation = validatePasswordStrength(confirmPassword);
                if (!confirmPasswordValidation.isValid) {
                    errorMessage.textContent = "Confirm password: " + confirmPasswordValidation.message;
                    errorMessage.style.display = "block";
                    return;
                }

                // Disable button during signup
                signupBtn.disabled = true;
                signupBtn.value = "Creating account...";

                try {
                    const result = await window.authService.signUp(email, password, firstName, lastName);

                    if (result.success) {
                        successMessage.textContent = "Account created successfully! Redirecting...";
                        successMessage.style.display = "block";
                        // Redirect to home page
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 1500);
                    } else {
                        errorMessage.textContent = result.error || "An error occurred. Please try again.";
                        errorMessage.style.display = "block";
                        signupBtn.disabled = false;
                        signupBtn.value = "Submit";
                    }
                } catch (error) {
                    console.error("Signup error:", error);
                    errorMessage.textContent = "An unexpected error occurred. Please try again.";
                    errorMessage.style.display = "block";
                    signupBtn.disabled = false;
                    signupBtn.value = "Submit";
                }
            });
        }

        initSignup();
    </script>
</body>
</html>
